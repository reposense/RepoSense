<html>
  <head>
    <link rel="stylesheet" href="../static/css/collapse.css">
    <link rel="stylesheet" href="../static/css/highlight-tomorrow.css">
        <link rel="stylesheet" href="../static/css/style.css">

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="../static/scripts/lib/highlight.pack.js"></script>
    <script type="text/javascript" src="../static/scripts/utils.js"></script>
    <script>

    var currentAuthor, currentAuthorDisplayName, app;

    Vue.component('accordion-menu', {
        props: ['file'],
        data: function () {
            return {
                collapse: false
            }
        },
        template:
            '<div>' +
            '<h3 class="collapse-container"> {{ file.path }} ( {{file.authorContributionMap[currentAuthor]}} lines)</h3>' +
            '<h6 class="collapse-container-small" @click="collapse = !collapse">Untouched Code Chunk(Click to Expand)</h6>' +
            '<pre class="collapse-code-detail" v-show="collapse" v-for="(line,index) in file.lines">' +
            '<code v-if="isAuthor(line, currentAuthor)">{{line.content}}</code>' +
            '</pre>' +
            '</div>',
        methods: {
            isAuthor: function (line, currentAuthor) {
                return currentAuthor != null && line.author != null && line.author.gitId === currentAuthor;
            },
        }
    });

    var initialize = function(){
      currentAuthor = getQueryVariable('author');
      currentAuthorDisplayName = getQueryVariable('authorDisplayName');
      resultJson = sortByLineContributed(resultJson,currentAuthor);

      app = new Vue({
          el: '#vue-app',
          data: {
            currentAuthor : currentAuthor,
            result : resultJson,
            searchType: "",
          },
          methods: {
          getAuthorUrlQuery : function (author) {
            return "?author=" + author
          },
          containAuthorLine : function(file, authorName){
            for (i=0; i<file.lines.length;i++){
              if (file.lines[i].author!= null && file.lines[i].author.gitId == authorName){
                return true;
              }
            }
            return false;
          },
          isFileMatch: function (searchType, filename) {
              var splitFilename = filename.split('.');
              var indexOfLastMatch = splitFilename.length - 1;
              var fileType = splitFilename[indexOfLastMatch];
              return fileType.toLowerCase().indexOf(searchType.toLowerCase()) != -1;
          },
          obtainMatchedFiles(result, searchType) {
              var filteredFiles = [];
              for (var file in result) {
                  if (!{}.hasOwnProperty.call(result, file)) {
                      continue;
                  }
                  if (this.isFileMatch(searchType, result[file].path)) {
                      filteredFiles.push(result[file]);
                  }
              }
              return filteredFiles;
          },
          }
      });
    };
    </script>
    <script type="text/javascript" src="result.js"></script>
  </head>

  <body>
    <div id="vue-app">
      <div class="toolbar" style="">
        <div class="filter-row">
          <label>current author:{{currentAuthorDisplayName==null?currentAuthor:currentAuthorDisplayName}}</label>
          <label>Search:</label><input type="text" v-model="searchType" size="50"/>
        </div>
      </div>
      <accordion-menu v-for="(file, index) in obtainMatchedFiles(result, searchType)"
                        v-if="containAuthorLine(file, currentAuthor) || currentAuthor == null"
                        v-bind:key="file.path"
                        v-bind:file="file"></accordion-menu>
    </div>
  </body>

</html>
